# 马尔可夫链与 Metropolis 采样

[从马尔可夫链到蒙特卡洛-Metropolis 方法（Python） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/146020807)
[如何理解 MCMC 中的细致平稳条件？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/63305712)

---

## 蒙特卡洛积分的误差

分布的波动带来了误差：例如如果在某个区域内分布很密集，在另一个区域分布很稀疏，那么计算结果会偏差很大。可以使用统计的标准差来估计随机抽样的可能误差：
![](pic/Pasted%20image%2020240325204152.png)
在这样的简单例子里，无法体现蒙特卡洛方法的优势，例如对于梯形积分法，其误差
![](pic/Pasted%20image%2020240325204233.png)
蒙特卡洛法的误差高于梯形积分法。
但是在高维积分里，蒙特卡洛法的误差依然正比于  $\frac{1}{M^{0.5}}$ ，但是随着维度的增高，例如对于  d  维积分，梯形积分法的误差
![](pic/Pasted%20image%2020240325204329.png)
这时蒙特卡洛法具有很大的优势。

## 马尔科夫链与 Metropolis 采样法

这里我们要一举解决最核心的关键问题：对于任意给定的目标分布$\pi$，我们如何找到以他为唯一平稳分布的马尔科夫链，并且基于马尔科夫链采样的方法，实现对其的近似采样。

找这么一个马尔科夫链，本质上就是要找到他的转移概率矩阵  P。使得 P 矩阵成立的条件是**马尔科夫链的细致平稳条件**。

### 平稳分布判定：细致平稳条件

$$\pi_i\,p_{ij}=\pi_j\,p_{ji}$$
则称状态分布满足马尔科夫链的细致平衡条件，该状态分布就是马尔科夫链的平稳分布。

看得出，细致平稳条件是一个充分条件，这个条件很强，只要满足了他，就相当于找到了我们要的马尔科夫链。我们来证明一下，很简单：
两边对 i 求和
$$\sum_i \pi_i\,p_{ij}=\sum_i \pi_j\,p_{ji}$$
$$\pi_j=\pi_j\sum_i \,p_{ji}$$
由于从状态 j 出发到所有 i 状态的概率之和为 1，故
$$\sum_i \,p_{ji}=1$$
$$\pi_j=\pi_j\sum_i \,p_{ji}=\pi_j$$
用一个式子综合起来就是：$\pi P=\pi$
满足细致平稳条件的目标分布  pi  就是以矩阵  P  为状态转移矩阵的马尔科夫链的平稳分布。

并且如果此时这个转移概率矩阵对应的马尔科夫链满足不可约、非周期和正常返，那么进一步说明该状态分布 pi 是马尔科夫链的唯一平稳分布。当然如果找到了这个转移矩阵 P，一般而言都是满足这个条件的。

因此，一旦找到了状态转移矩阵，就确定了马尔科夫链。

可是问题来了，感觉还是很难找到这个矩阵啊，例如，我们随便找一个状态转移矩阵 Q，一般是无法满足细致平稳条件的，即：
$$\sum_i \pi_i\,Q_{ij}\not =\sum_i \pi_j\,Q_{ji}$$

### Metropolis-Hastings 采样方法

![](pic/Pasted%20image%2020240326105337.png)
![](pic/Pasted%20image%2020240326105356.png)
![](pic/Pasted%20image%2020240326105451.png)
![](pic/Pasted%20image%2020240326105522.png)
![](pic/Pasted%20image%2020240326105547.png)

### 如何理解 随机游走叠加接受概率

![](pic/Pasted%20image%2020240326105646.png)
![](https://pic1.zhimg.com/80/v2-e7974d84d09de7c3a6cdab57e7916873_720w.webp?source=1def8aca)

### 建议转移概率矩阵 Q 的设计

![](pic/Pasted%20image%2020240326105818.png)
在以 x 为均值的正态分布中采样出 x_star 的概率。
![](pic/Pasted%20image%2020240326105936.png)

### Metorpolis 采样步骤与程序

![](pic/Pasted%20image%2020240326110023.png)
![](https://pica.zhimg.com/80/v2-e06e789125a4014ffea8dc9c267cf8cf_720w.webp?source=1def8aca)
